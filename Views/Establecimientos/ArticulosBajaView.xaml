<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AsadorMoron.Views.Establecimientos.ArticulosBajaView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:ff="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
    x:Name="ViewArticulosBaja"
    BackgroundColor="{StaticResource Rojo}"
    IconImageSource="menu.png">
    <NavigationPage.TitleView>
        <Grid HorizontalOptions="FillAndExpand" ColumnDefinitions="*,Auto">
            <Label
                Grid.Column="0"
                Grid.ColumnSpan="2"
                Margin="0,0,50,0"
                FontFamily="Syne"
                FontSize="25"
                HorizontalTextAlignment="Center"
                Text="Prod. Baja"
                TextColor="{DynamicResource Negro}"
                VerticalOptions="Center" />
            <ImageButton
                Grid.Column="1"
                Margin="0,0,10,0"
                BackgroundColor="Transparent"
                Command="{Binding NuevoProductoCommand}"
                HeightRequest="30"
                HorizontalOptions="End"
                Source="export_excel.png"
                WidthRequest="30" />
        </Grid>
    </NavigationPage.TitleView>

    <Grid
        Margin="{OnPlatform Default='0,90,0,0', Android='0,0,0,0', WinUI='0'}"
        HorizontalOptions="FillAndExpand"
        RowDefinitions="Auto,Auto,*"
        RowSpacing="0"
        VerticalOptions="FillAndExpand">

        <!-- Barra de búsqueda -->
        <Grid Grid.Row="0" Margin="{OnPlatform Android='20,10,20,10', Default='20,5'}">
            <Border
                BackgroundColor="White"
                StrokeShape="RoundRectangle 8"
                Stroke="LightGray"
                StrokeThickness="1"
                Padding="0">
                <Entry
                    x:Name="TextoBusqueda"
                    BackgroundColor="Transparent"
                    FontFamily="Syne_Regular"
                    FontSize="14"
                    Keyboard="Plain"
                    Placeholder="Buscar producto..."
                    PlaceholderColor="Gray"
                    Text="{Binding TextoBusqueda}"
                    TextColor="{DynamicResource Negro}"
                    Margin="10,0,50,0"/>
            </Border>
            <ImageButton
                Padding="7"
                BackgroundColor="{DynamicResource Amarillo}"
                Command="{Binding btnFiltrar}"
                HeightRequest="40"
                HorizontalOptions="End"
                Source="lupa.png"
                WidthRequest="45"
                CornerRadius="8"/>
        </Grid>

        <!-- Seleccionar todo + Activar -->
        <Border Grid.Row="1"
                BackgroundColor="White"
                Margin="{OnPlatform WinUI='20,5', Default='0'}"
                StrokeThickness="0"
                Padding="10,5">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <HorizontalStackLayout Grid.Column="0" Spacing="5">
                    <CheckBox
                        IsChecked="{Binding TodoSeleccionado}"
                        Color="{DynamicResource Rojo}"/>
                    <Label
                        Text="Seleccionar todo"
                        TextColor="{DynamicResource Negro}"
                        FontFamily="Syne_Regular"
                        FontSize="14"
                        VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <Button
                    Grid.Column="2"
                    Text="Activar seleccionados"
                    Command="{Binding cmdActivar}"
                    BackgroundColor="{DynamicResource Amarillo}"
                    TextColor="{DynamicResource Negro}"
                    FontFamily="Syne_Regular"
                    FontSize="12"
                    HeightRequest="35"
                    CornerRadius="8"
                    Padding="15,0"/>
            </Grid>
        </Border>

        <!-- Lista de categorías con productos -->
        <CollectionView
            Grid.Row="2"
            BackgroundColor="White"
            IsGrouped="True"
            ItemsSource="{Binding ListadoCategorias}"
            SelectionMode="None"
            ItemSizingStrategy="MeasureFirstItem">

            <CollectionView.GroupHeaderTemplate>
                <DataTemplate>
                    <Border
                        BackgroundColor="{StaticResource Amarillo}"
                        StrokeThickness="0"
                        Margin="0,10,0,0"
                        Padding="0">
                        <Grid
                            HeightRequest="50"
                            ColumnDefinitions="*,Auto"
                            Padding="15,0">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Path=BindingContext.HeaderTapped, Source={x:Reference Name=ViewArticulosBaja}}"
                                    CommandParameter="{Binding Categoria}" />
                            </Grid.GestureRecognizers>

                            <Label
                                Grid.Column="0"
                                FontFamily="Syne"
                                FontSize="16"
                                FontAttributes="Bold"
                                Text="{Binding Categoria}"
                                TextColor="{DynamicResource Negro}"
                                VerticalOptions="Center"/>

                            <HorizontalStackLayout Grid.Column="1" Spacing="10" VerticalOptions="Center">
                                <Label
                                    Text="{Binding EventosCount, StringFormat='({0})'}"
                                    TextColor="{DynamicResource Negro}"
                                    FontFamily="Syne_Regular"
                                    FontSize="14"
                                    VerticalOptions="Center"/>
                                <Image
                                    Source="{Binding StateIcon}"
                                    HeightRequest="20"
                                    WidthRequest="20"
                                    VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border
                        BackgroundColor="White"
                        StrokeThickness="0"
                        Margin="0,0,0,1"
                        Padding="5,8">
                        <Grid
                            ColumnDefinitions="40,80,*,40"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="2">

                            <!-- CheckBox -->
                            <CheckBox
                                Grid.Row="0"
                                Grid.RowSpan="2"
                                Grid.Column="0"
                                Color="{DynamicResource Rojo}"
                                IsChecked="{Binding articulo.seleccionado}"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"/>

                            <!-- Imagen del producto -->
                            <Border
                                Grid.Row="0"
                                Grid.RowSpan="2"
                                Grid.Column="1"
                                StrokeShape="RoundRectangle 8"
                                StrokeThickness="0"
                                BackgroundColor="#F5F5F5"
                                HeightRequest="70"
                                WidthRequest="70"
                                VerticalOptions="Center">
                                <ff:CachedImage
                                    Aspect="AspectFill"
                                    Source="{Binding articulo.imagen}"
                                    HeightRequest="70"
                                    WidthRequest="70">
                                    <ff:CachedImage.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference Name=ViewArticulosBaja}}"
                                            CommandParameter="{Binding articulo.idArticulo}" />
                                    </ff:CachedImage.GestureRecognizers>
                                </ff:CachedImage>
                            </Border>

                            <!-- Nombre del producto -->
                            <Label
                                Grid.Row="0"
                                Grid.Column="2"
                                FontFamily="Syne_Medium"
                                FontSize="15"
                                FontAttributes="Bold"
                                LineBreakMode="TailTruncation"
                                MaxLines="2"
                                Text="{Binding articulo.nombre}"
                                TextColor="{DynamicResource Negro}"
                                VerticalOptions="End">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference Name=ViewArticulosBaja}}"
                                        CommandParameter="{Binding articulo.idArticulo}" />
                                </Label.GestureRecognizers>
                            </Label>

                            <!-- Precio -->
                            <Label
                                Grid.Row="1"
                                Grid.Column="2"
                                FontFamily="Nunito_bold"
                                FontSize="16"
                                Text="{Binding articulo.precio, StringFormat='{0:N2}€'}"
                                TextColor="{DynamicResource Rojo}"
                                VerticalOptions="Start">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference Name=ViewArticulosBaja}}"
                                        CommandParameter="{Binding articulo.idArticulo}" />
                                </Label.GestureRecognizers>
                            </Label>

                            <!-- Botón eliminar -->
                            <ImageButton
                                Grid.Row="0"
                                Grid.RowSpan="2"
                                Grid.Column="3"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"
                                HeightRequest="35"
                                WidthRequest="35"
                                Source="eliminar.png"
                                BackgroundColor="Transparent"
                                Command="{Binding Path=BindingContext.EliminarProductoCommand, Source={x:Reference Name=ViewArticulosBaja}}"
                                CommandParameter="{Binding articulo}"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

        <!-- Mensaje cuando no hay productos (fuera del CollectionView para evitar problemas con grupos colapsados) -->
        <StackLayout
            Grid.Row="2"
            IsVisible="{Binding SinProductos}"
            VerticalOptions="Center"
            HorizontalOptions="Center"
            Padding="20"
            BackgroundColor="White">
            <Label
                Text="No hay productos dados de baja"
                FontFamily="Syne_Regular"
                FontSize="16"
                TextColor="Gray"
                HorizontalOptions="Center"/>
        </StackLayout>
    </Grid>
</ContentPage>
