<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AsadorMoron.Views.Clientes.CartaProductosView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:badge="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
    xmlns:ff="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
    x:Name="CartaProductos"
    BackgroundColor="{DynamicResource Rojo}"
    IconImageSource="menu.png">
    <NavigationPage.TitleView>
         <Grid HorizontalOptions="FillAndExpand" ColumnDefinitions="*,Auto">
                <Image
                    Grid.Column="0"
                    Aspect="AspectFit"
                    HeightRequest="35"
                    Source="logoqoorder"
                    HorizontalOptions="CenterAndExpand"
                    VerticalOptions="StartAndExpand" />
           <ImageButton
                BackgroundColor="Transparent"
                Command="{Binding IrDetallePedidoCommand}"
                HeightRequest="40"
                Grid.Column="2"
                Margin="0,0,20,0"
                Source="carrito.png"
                WidthRequest="40" />
             <Frame Padding="0" BackgroundColor="{DynamicResource Amarillo}" WidthRequest="30" HeightRequest="30" CornerRadius="15"
                   VerticalOptions="Start" HorizontalOptions="End" Grid.Column="2" HasShadow="False">
                <Label Text="{Binding Cantidad, Mode=TwoWay}"
                       FontSize="15" TextColor="Black" FontAttributes="Bold"
                       VerticalTextAlignment="Center" HorizontalTextAlignment="Center"
                       HorizontalOptions="Center" VerticalOptions="Center"/>
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding IrDetallePedidoCommand}"/>
                </Frame.GestureRecognizers>
             </Frame>
        </Grid>
    </NavigationPage.TitleView>
    <ContentPage.Content>
        <Grid
            Margin="0"
            HorizontalOptions="FillAndExpand"
            RowDefinitions="Auto,*"
            RowSpacing="0"
            VerticalOptions="FillAndExpand">
            <!-- Buscador simplificado -->
            <Frame Grid.Row="0"
                   Margin="16,16,16,8"
                   Padding="8"
                   CornerRadius="12"
                   HasShadow="False"
                   BackgroundColor="#F5F5F5"
                   BorderColor="#E0E0E0">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <Image Source="lupa.png"
                           WidthRequest="20"
                           HeightRequest="20"
                           Margin="4,0,8,0"
                           VerticalOptions="Center"/>
                    <Entry Grid.Column="1"
                           Placeholder="Buscar productos..."
                           PlaceholderColor="#999999"
                           Text="{Binding TextoBusqueda}"
                           TextColor="{DynamicResource Negro}"
                           FontFamily="Nunito"
                           FontSize="15"
                           BackgroundColor="Transparent"
                           VerticalOptions="Center"/>
                    <ImageButton Grid.Column="2"
                                 Source="cerrar.png"
                                 WidthRequest="20"
                                 HeightRequest="20"
                                 BackgroundColor="Transparent"
                                 IsVisible="{Binding TextoBusqueda, Converter={StaticResource StringEmptyToBooleanConverter}}"
                                 Command="{Binding LimpiarBusquedaCommand}"
                                 VerticalOptions="Center"/>
                </Grid>
            </Frame>
            <Grid Margin="0,0,0,0" Grid.Row="1" RowDefinitions="Auto,*">
                <StackLayout Margin="-20,0" IsVisible="{Binding SistemaPuntos}" Grid.Row="0" BackgroundColor="{DynamicResource Amarillo}" HorizontalOptions="FillAndExpand">
                    <Label Text="{Binding Puntos,StringFormat='Tienes {0} puntos'}" HorizontalTextAlignment="Center"
                           TextColor="{DynamicResource Negro}" FontFamily="Nunito_bold" FontSize="20"/>
                </StackLayout>
                <!-- Listado de productos rediseñado -->
                <CollectionView
                    BackgroundColor="White"
                    Grid.Row="1"
                    ItemSizingStrategy="MeasureAllItems"
                    ItemsSource="{Binding Comidas}"
                    SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="12,6"
                                    Padding="0"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 16"
                                    BackgroundColor="White">
                                <Border.Shadow>
                                    <Shadow Brush="#000000" Offset="0,2" Radius="8" Opacity="0.08"/>
                                </Border.Shadow>
                                <Grid ColumnDefinitions="100,*" ColumnSpacing="0">
                                    <!-- Imagen del producto -->
                                    <Border Grid.Column="0"
                                            StrokeThickness="0"
                                            StrokeShape="RoundRectangle 16,0,0,16"
                                            HeightRequest="110">
                                        <ff:CachedImage
                                            Aspect="AspectFill"
                                            Source="{Binding articulo.imagen}"
                                            DownsampleToViewSize="True"
                                            LoadingPlaceholder="logo_producto.png"
                                            ErrorPlaceholder="logo_producto.png"
                                            CacheType="All"
                                            FadeAnimationEnabled="False">
                                            <ff:CachedImage.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference CartaProductos}}" CommandParameter="{Binding .}" />
                                            </ff:CachedImage.GestureRecognizers>
                                        </ff:CachedImage>
                                    </Border>
                                    <!-- Badge Por Encargo -->
                                    <Border Grid.Column="0"
                                            BackgroundColor="{DynamicResource Rojo}"
                                            StrokeThickness="0"
                                            StrokeShape="RoundRectangle 6"
                                            Padding="6,3"
                                            Margin="6"
                                            VerticalOptions="Start"
                                            HorizontalOptions="Start"
                                            IsVisible="{Binding articulo.porEncargo}">
                                        <Label Text="ENCARGO"
                                               TextColor="White"
                                               FontFamily="Nunito_bold"
                                               FontSize="9"/>
                                    </Border>

                                    <!-- Contenido -->
                                    <Grid Grid.Column="1"
                                          Padding="12,10"
                                          RowDefinitions="Auto,Auto,*,Auto"
                                          RowSpacing="4">
                                        <!-- Nombre -->
                                        <Label Grid.Row="0"
                                               FontFamily="Nunito_bold"
                                               FontSize="15"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2"
                                               Text="{Binding NombreLocalizado}"
                                               TextColor="{DynamicResource Negro}">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference CartaProductos}}" CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>

                                        <!-- Descripción -->
                                        <Label Grid.Row="1"
                                               FontFamily="Nunito"
                                               FontSize="11"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1"
                                               Text="{Binding DescripcionLocalizada}"
                                               TextColor="#888888"/>

                                        <!-- Comentario - solo si Logado + sin opciones -->
                                        <Border Grid.Row="2"
                                                BackgroundColor="#F5F5F5"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 8"
                                                Padding="8,0"
                                                IsVisible="False"
                                                VerticalOptions="Center"
                                                HeightRequest="30">
                                            <Border.Triggers>
                                                <MultiTrigger TargetType="Border">
                                                    <MultiTrigger.Conditions>
                                                        <BindingCondition Binding="{Binding noTieneOpciones}" Value="True"/>
                                                        <BindingCondition Binding="{Binding Path=BindingContext.Logado, Source={x:Reference CartaProductos}}" Value="True"/>
                                                    </MultiTrigger.Conditions>
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </MultiTrigger>
                                            </Border.Triggers>
                                            <Entry Placeholder="Añadir comentario..."
                                                   PlaceholderColor="#AAAAAA"
                                                   FontFamily="Nunito"
                                                   FontSize="11"
                                                   Text="{Binding articulo.comentario}"
                                                   TextColor="{DynamicResource Negro}"
                                                   BackgroundColor="Transparent"
                                                   VerticalOptions="Center"/>
                                        </Border>

                                        <!-- Precio y Controles -->
                                        <Grid Grid.Row="3" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                            <!-- Precio -->
                                            <Label Grid.Column="0"
                                                   IsVisible="{Binding Path=BindingContext.EsPorPuntos, Source={x:Reference CartaProductos}, Converter={StaticResource InverseBoolConverter}}"
                                                   FontFamily="Nunito_bold"
                                                   FontSize="18"
                                                   Text="{Binding articulo.precio, StringFormat='{0:N2}€'}"
                                                   TextColor="{DynamicResource Negro}"
                                                   VerticalOptions="Center"/>

                                            <!-- Botón por Puntos (si aplica) -->
                                            <Border Grid.Column="0"
                                                    BackgroundColor="{DynamicResource Amarillo}"
                                                    StrokeThickness="0"
                                                    StrokeShape="RoundRectangle 14"
                                                    Padding="12,6"
                                                    IsVisible="{Binding Path=BindingContext.EsPorPuntos, Source={x:Reference CartaProductos}}"
                                                    VerticalOptions="Center">
                                                <Label Text="{Binding articulo.puntos, StringFormat='{0} Pts'}"
                                                       TextColor="{DynamicResource Negro}"
                                                       FontFamily="Nunito_bold"
                                                       FontSize="12"/>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Path=BindingContext.ClickPorPuntosCommand, Source={x:Reference CartaProductos}}" CommandParameter="{Binding articulo}"/>
                                                </Border.GestureRecognizers>
                                            </Border>

                                            <!-- Botones - Cantidad + (Logado + SIN opciones) -->
                                            <Border Grid.Column="2"
                                                    BackgroundColor="#F0F0F0"
                                                    StrokeThickness="0"
                                                    StrokeShape="RoundRectangle 18"
                                                    Padding="0"
                                                    HeightRequest="36"
                                                    IsVisible="False"
                                                    VerticalOptions="Center">
                                                <Border.Triggers>
                                                    <MultiTrigger TargetType="Border">
                                                        <MultiTrigger.Conditions>
                                                            <BindingCondition Binding="{Binding noTieneOpciones}" Value="True"/>
                                                            <BindingCondition Binding="{Binding Path=BindingContext.Logado, Source={x:Reference CartaProductos}}" Value="True"/>
                                                        </MultiTrigger.Conditions>
                                                        <Setter Property="IsVisible" Value="True"/>
                                                    </MultiTrigger>
                                                </Border.Triggers>
                                                <Grid ColumnDefinitions="36,40,36" ColumnSpacing="0" VerticalOptions="Center">
                                                    <!-- Botón Menos -->
                                                    <Border Grid.Column="0"
                                                            BackgroundColor="{DynamicResource Rojo}"
                                                            StrokeThickness="0"
                                                            StrokeShape="RoundRectangle 18"
                                                            WidthRequest="36"
                                                            HeightRequest="36">
                                                        <Label Text="−"
                                                               TextColor="White"
                                                               FontSize="22"
                                                               FontFamily="Nunito_bold"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center"/>
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Path=BindingContext.ClickMenosCommand, Source={x:Reference CartaProductos}}" CommandParameter="{Binding articulo}"/>
                                                        </Border.GestureRecognizers>
                                                    </Border>
                                                    <!-- Cantidad -->
                                                    <Label Grid.Column="1"
                                                           FontFamily="Nunito_bold"
                                                           FontSize="16"
                                                           VerticalOptions="Center"
                                                           HorizontalOptions="Center"
                                                           Text="{Binding articulo.Cantidad}"
                                                           TextColor="{DynamicResource Negro}"/>
                                                    <!-- Botón Más -->
                                                    <Border Grid.Column="2"
                                                            BackgroundColor="{DynamicResource Amarillo}"
                                                            StrokeThickness="0"
                                                            StrokeShape="RoundRectangle 18"
                                                            WidthRequest="36"
                                                            HeightRequest="36">
                                                        <Label Text="+"
                                                               TextColor="{DynamicResource Negro}"
                                                               FontSize="22"
                                                               FontFamily="Nunito_bold"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center"/>
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Path=BindingContext.ClickMasCommand, Source={x:Reference CartaProductos}}" CommandParameter="{Binding articulo}"/>
                                                        </Border.GestureRecognizers>
                                                    </Border>
                                                </Grid>
                                            </Border>

                                            <!-- Botón Ver Opciones (Logado + CON opciones) -->
                                            <Border Grid.Column="2"
                                                    BackgroundColor="{DynamicResource Rojo}"
                                                    StrokeThickness="0"
                                                    StrokeShape="RoundRectangle 14"
                                                    Padding="14,8"
                                                    IsVisible="False"
                                                    VerticalOptions="Center">
                                                <Border.Triggers>
                                                    <MultiTrigger TargetType="Border">
                                                        <MultiTrigger.Conditions>
                                                            <BindingCondition Binding="{Binding noTieneOpciones}" Value="False"/>
                                                            <BindingCondition Binding="{Binding Path=BindingContext.Logado, Source={x:Reference CartaProductos}}" Value="True"/>
                                                        </MultiTrigger.Conditions>
                                                        <Setter Property="IsVisible" Value="True"/>
                                                    </MultiTrigger>
                                                </Border.Triggers>
                                                <Label Text="Opciones"
                                                       TextColor="White"
                                                       FontFamily="Nunito_bold"
                                                       FontSize="12"/>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Path=BindingContext.ArticuloSeleccionado, Source={x:Reference CartaProductos}}" CommandParameter="{Binding .}"/>
                                                </Border.GestureRecognizers>
                                            </Border>
                                        </Grid>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
            <!-- Login banner simplificado -->
            <Frame Grid.Row="1"
                   VerticalOptions="End"
                   Margin="16,0,16,20"
                   Padding="12"
                   CornerRadius="20"
                   HasShadow="False"
                   BackgroundColor="{DynamicResource Rojo}"
                   BorderColor="{DynamicResource Amarillo}"
                   IsVisible="{Binding Logado, Converter={StaticResource InverseBoolConverter}}">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Icono usuario -->
                    <Frame Grid.Column="0"
                           BackgroundColor="White"
                           CornerRadius="18"
                           Padding="6"
                           HasShadow="False"
                           WidthRequest="36"
                           HeightRequest="36"
                           VerticalOptions="Center">
                        <Image Source="user.png"
                               WidthRequest="20"
                               HeightRequest="20"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Frame>
                    <!-- Texto -->
                    <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="0" Margin="10,0">
                        <Label Text="Inicia sesion" TextColor="White" FontFamily="Nunito_bold" FontSize="14"/>
                        <Label Text="para realizar tu pedido" TextColor="#FFCCCC" FontFamily="Nunito" FontSize="11"/>
                    </StackLayout>
                    <!-- Boton entrar -->
                    <Frame Grid.Column="2"
                           CornerRadius="12"
                           BackgroundColor="{DynamicResource Amarillo}"
                           Padding="16,8"
                           HasShadow="False"
                           VerticalOptions="Center">
                        <Label Text="ENTRAR" TextColor="{DynamicResource Negro}" FontFamily="Nunito_bold" FontSize="12"/>
                    </Frame>
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding loginCommand}"/>
                    </Grid.GestureRecognizers>
                </Grid>
            </Frame>
        </Grid>
    </ContentPage.Content>
</ContentPage>
